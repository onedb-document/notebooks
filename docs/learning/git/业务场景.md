# 结合业务场景

## 仓库迁移

场景：因为技改重构等原因，在一段时间内，一部分人做重构工作（在新仓库内开发），一部分人还在做正常业务迭代（在老仓库内开发）
操作：

1. 新仓库从原仓库 clone 出来，该删改的删改
2. 老项目迭代合并到 master（上线）的时候，新仓库的开发人员持续的更新新仓库的 master 分支。具体操作也就是添加多个远端：

```bash
# 添加新仓库远端为origin
git remote add origin new_git_url
# 添加旧仓库远端为origin0
git remote add origin0 old_git_url
# 老仓库（生产环境）有项目上线，同步master
git pull origin0 master
# 解决冲突（一般会有的）
```

## master 版本回退

场景：不说原因了，总之各种情况有问题的代码漏到 master 分支了，需要做版本回退。
操作：

1. 评估是否需要做版本回退？
   按照现代化的部署方式的话，配置灰度、AB 等方式能否解决生产问题。
2. 评估是否能做版本回退？
   如果发布涉及到的内容过多（比如后端服务、数据库修改、运维配置），或者当天发布了好几个版本，要回退到很早的一个版本，评估这些如果不太可控的话，就会很有风险。
3. 确定可以做版本回退的话，推荐使用`git revert <release-commit-id>`命令
   不推荐使用`git reset`，是因为不确定是否有人已经根据“有问题的 master 分支”切分支进行开发了，所以附加一个 revert 提交，在他们合 master 的时候，也会把 revert 提交合进去。

## 开发分支版本回退

场景分类讨论：单人、多人未提交远端、多人提交远端、发布生产之后

- 版本回退
  git reset

git revert

如果是生产环境，需要回退很多个版本的情况，这时候就需要评估下了，因为可能需要涉及到的方面比较多。
比如说除了前端的回滚后端的服务回滚、配置回滚，不太可控。

所以上线的时候需要做好灰度、AB，控制发布的周期。
